<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Google Sheets</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILOS VISUALES --- */
        body { background-color: #121212; color: #e0e0e0; font-family: 'Roboto', sans-serif; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .dashboard-container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; max-width: 1000px; width: 100%; }
        .card { background-color: #1e1e2f; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 180px; }
        h3 { margin-top: 0; color: #8b9bb4; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        .big-value { font-size: 3rem; font-weight: 700; margin: 10px 0; }
        .temp-color { color: #4facfe; }
        .bat-color { color: #00f260; }
        
        /* ALARMA */
        .alarm-light { width: 60px; height: 60px; background-color: #330000; border-radius: 50%; margin-bottom: 10px; border: 2px solid #555; transition: all 0.3s ease; }
        .alarm-active { background-color: #ff0000; box-shadow: 0 0 20px #ff0000, 0 0 40px #ff0000; border-color: #ffcccc; animation: parpadeo 1s infinite; }
        @keyframes parpadeo { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .graph-card { grid-column: span 3; height: 400px; position: relative; }
        
        /* CONTROLES */
        .controls { grid-column: span 3; display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 5px; flex-wrap: wrap; }
        
        label { font-size: 0.9rem; color: #aaa; }
        
        select, input[type="number"] {
            background: #1e1e2f; color: #fff; border: 1px solid #4facfe; padding: 8px 10px; border-radius: 5px; cursor: pointer; outline: none; font-family: 'Roboto', sans-serif;
        }
        
        /* Ajustes específicos para los inputs */
        input[type="number"] { width: 60px; cursor: text; text-align: center; }
        #manualInput { display: none; width: 80px; }

        #status-indicator { grid-column: span 3; text-align: center; font-size: 0.8rem; color: #666; margin-bottom: 10px; }

        @media (max-width: 768px) { .dashboard-container { grid-template-columns: 1fr; } .graph-card { grid-column: span 1; } .controls { justify-content: center; } }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <div id="status-indicator">Iniciando...</div>

        <div class="card">
            <h3>Temperatura</h3>
            <div class="big-value temp-color"><span id="tempValue">--</span> °C</div>
        </div>
        <div class="card">
            <h3>Estado Batería</h3>
            <div class="big-value bat-color"><span id="batPercent">--</span>%</div>
        </div>
        <div class="card">
            <h3>Alarma</h3>
            <div id="alarmLight" class="alarm-light"></div> 
            <div id="alarmText" style="font-weight: bold; color: #555;">ESPERANDO</div>
        </div>

        <div class="controls">
            <label for="sampleLimit">Ver:</label>
            <select id="sampleLimit" onchange="verificarModo()">
                <option value="5">Últimas 5</option>
                <option value="15" selected>Últimas 15</option>
                <option value="30">Últimas 30</option>
                <option value="50">Últimas 50</option>
                <option value="0">Todo el Histórico</option>
                <option value="manual">Manual...</option>
            </select>
            <input type="number" id="manualInput" placeholder="Nº" min="1" value="20" oninput="actualizarGraficas()">

            <label for="dateInput">Fecha:</label>
            <input type="text" id="dateInput" title="yyyy-mm-dd"><div style="width: 20px;"></div> 
            
        </div>

        <div class="card graph-card">
            <canvas id="tempChart"></canvas>
        </div>
        <div class="card graph-card">
            <canvas id="batChart"></canvas>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzl4s-9Ry-KleGBsuYN69yZUqn4LYTDdSN_OAjmqGPMds4dzqFu-GJVgohqXs1C_M8P/exec";

        let globalTemps = [];
        let globalBats = [];
        let globalRawTimes = []; // Guardamos los tiempos "crudos" sin procesar

        // Configuración Gráficas
        const commonOptions = {
            responsive: true, maintainAspectRatio: false,
            scales: { y: { grid: { color: '#333' }, ticks: { color: '#aaa' } }, x: { grid: { color: '#333' }, ticks: { color: '#aaa', maxRotation: 45, minRotation: 45 } } },
            plugins: { legend: { display: false } },
            elements: { point: { radius: 2 } }
        };

        const tempChart = new Chart(document.getElementById('tempChart'), { type: 'line', data: { labels: [], datasets: [{ label: 'Temp', data: [], borderColor: '#4facfe', backgroundColor: 'rgba(79, 172, 254, 0.2)', borderWidth: 2, tension: 0.2, fill: true }] }, options: commonOptions });
        const batChart = new Chart(document.getElementById('batChart'), { type: 'line', data: { labels: [], datasets: [{ label: 'Bat', data: [], borderColor: '#00f260', backgroundColor: 'rgba(0, 242, 96, 0.2)', borderWidth: 2, tension: 0.2, fill: true }] }, options: commonOptions });

        function verificarModo() {
            const selector = document.getElementById('sampleLimit');
            const manualInput = document.getElementById('manualInput');
            if (selector.value === "manual") {
                manualInput.style.display = "block";
                manualInput.focus();
            } else {
                manualInput.style.display = "none";
            }
            actualizarGraficas();
        }


        async function descargarDatos() {
            const statusDiv = document.getElementById('status-indicator');
            const dateInput = document.getElementById('dateInput');
            if(globalRawTimes.length === 0) statusDiv.innerText = "Sincronizando...";
            
            try {
                const [resTime, resTemp, resBat] = await Promise.all([
                    fetch(`${APPS_SCRIPT_URL}?action=getDate&campo=6&date=${dateInput.value}`).then(r => r.json()),
                    fetch(`${APPS_SCRIPT_URL}?action=getDate&campo=1&date=${dateInput.value}`).then(r => r.json()),
                    fetch(`${APPS_SCRIPT_URL}?action=getDate&campo=3&date=${dateInput.value}`).then(r => r.json())
                ]);

                // Guardamos los datos "crudos" y luego los procesamos en actualizarGraficas
                globalRawTimes = resTime; 
                globalTemps = resTemp.map(t=>t.replace(',', '.')).map(t => parseFloat(t));
                globalBats = resBat.map(t=>t.replace(',', '.')).map(t => parseFloat(t));

                if (resTime.error || resTemp.error) {
                    statusDiv.innerText = "Error leyendo Excel.";
                    return;
                }
                actualizarGraficas(); 
                statusDiv.innerText = "Actualizado: " + new Date().toLocaleTimeString();
            } catch (error) {
                console.error(error);
                statusDiv.innerText = "Reintentando conexión...";
            }
        }

        function actualizarGraficas() {
            if (globalRawTimes.length === 0) return;

            // 1. Leer Configuración
            const selector = document.getElementById('sampleLimit');
            const manualInput = document.getElementById('manualInput');
            
            
            let limit;
            if (selector.value === "manual") {
                limit = parseInt(manualInput.value) || 10;
            } else {
                limit = parseInt(selector.value);
            }

            // 2. Procesar las horas con el ajuste actual
            
            const tiemposProcesados = globalRawTimes

            // 3. Recortar arrays
            let labelsCortados, tempCortados, batCortados;
            
            if (limit === 0 || limit > globalRawTimes.length) {
                labelsCortados = tiemposProcesados;
                tempCortados = globalTemps;
                batCortados = globalBats;
            } else {
                labelsCortados = tiemposProcesados.slice(-limit);
                tempCortados = globalTemps.slice(-limit);
                batCortados = globalBats.slice(-limit);
            }

            // 4. Actualizar Gráficas
            tempChart.data.labels = labelsCortados;
            tempChart.data.datasets[0].data = tempCortados;
            tempChart.update();

            batChart.data.labels = labelsCortados;
            batChart.data.datasets[0].data = batCortados;
            batChart.update();

            // 5. Actualizar Valores Numéricos
            const ultimoTemp = globalTemps[globalTemps.length - 1];
            const ultimoBat = globalBats[globalBats.length - 1];
            document.getElementById('tempValue').innerText = ultimoTemp;
            document.getElementById('batPercent').innerText = ultimoBat;

            // 6. Alarma
            const light = document.getElementById('alarmLight');
            const txt = document.getElementById('alarmText');
            if (parseFloat(ultimoBat) < 20) {
                light.classList.add('alarm-active');
                txt.innerText = "¡BATERÍA BAJA!";
                txt.style.color = "#ff4444";
            } else {
                light.classList.remove('alarm-active');
                txt.innerText = "NORMAL";
                txt.style.color = "#555";
            }
        }

        descargarDatos(); 
        setInterval(descargarDatos, 10000); 
    </script>
</body>
</html>